<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TinyBMS Configuration</title>
    <link rel="stylesheet" href="/style.css">
    <style>
        .config-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        
        .config-section {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .config-section h3 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }
        
        .config-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 80px;
            gap: 15px;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .config-item:last-child {
            border-bottom: none;
        }
        
        .config-item:hover {
            background: rgba(0,0,0,0.02);
        }
        
        .config-label {
            display: flex;
            flex-direction: column;
        }
        
        .config-label-main {
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 4px;
        }
        
        .config-label-desc {
            font-size: 0.85em;
            color: var(--text-light);
        }
        
        .config-label-comment {
            font-size: 0.75em;
            color: var(--warning-color);
            margin-top: 4px;
        }
        
        .config-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .config-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
        }
        
        .config-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .config-range {
            font-size: 0.85em;
            color: var(--text-light);
        }
        
        .config-current {
            font-weight: 600;
            color: var(--success-color);
        }
        
        .config-actions {
            display: flex;
            gap: 5px;
        }
        
        .btn-read, .btn-write {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }
        
        .btn-read {
            background: var(--info-color);
            color: white;
        }
        
        .btn-read:hover {
            background: #2980b9;
        }
        
        .btn-write {
            background: var(--success-color);
            color: white;
        }
        
        .btn-write:hover {
            background: #27ae60;
        }
        
        .bulk-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .bulk-actions button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-read-all {
            background: var(--info-color);
            color: white;
        }
        
        .btn-write-all {
            background: var(--warning-color);
            color: white;
        }
        
        .btn-reset {
            background: var(--secondary-color);
            color: white;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            display: none;
        }
        
        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.6s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .warning-banner {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .warning-banner strong {
            display: block;
            margin-bottom: 5px;
        }
        
        @media (max-width: 768px) {
            .config-item {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .config-actions {
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîß TinyBMS Configuration</h1>
        <nav>
            <a href="/">Dashboard</a>
            <a href="/config.html" class="active">TinyBMS Config</a>
        </nav>
    </div>

    <div class="config-container">
        <!-- Warning Banner -->
        <div class="warning-banner">
            <strong>‚ö†Ô∏è Important Warnings:</strong>
            <ul style="margin: 10px 0 0 20px;">
                <li>Modifying safety parameters (registers 315-320) can damage your battery</li>
                <li>Always verify values before writing to TinyBMS</li>
                <li>Register 342 (Broadcast) and 343 (Protocol) must be configured for the bridge to work</li>
                <li>Changes take effect immediately after writing</li>
            </ul>
        </div>

        <!-- Status Message -->
        <div id="statusMessage" class="status-message"></div>

        <!-- Bulk Actions -->
        <div class="bulk-actions">
            <button class="btn-read-all" onclick="readAllRegisters()">
                üìñ Read All from TinyBMS
            </button>
            <button class="btn-write-all" onclick="writeAllRegisters()">
                ‚úçÔ∏è Write All to TinyBMS
            </button>
            <button class="btn-reset" onclick="resetToDefaults()">
                üîÑ Reset to Defaults
            </button>
        </div>

        <!-- Battery Parameters -->
        <div class="config-section">
            <h3>üîã Battery Parameters</h3>
            <div id="batteryParams"></div>
        </div>

        <!-- Charger Parameters -->
        <div class="config-section">
            <h3>‚ö° Charger Parameters</h3>
            <div id="chargerParams"></div>
        </div>

        <!-- Safety Parameters -->
        <div class="config-section">
            <h3>üõ°Ô∏è Safety Parameters</h3>
            <div id="safetyParams"></div>
        </div>

        <!-- Advanced Parameters -->
        <div class="config-section">
            <h3>‚öôÔ∏è Advanced Parameters</h3>
            <div id="advancedParams"></div>
        </div>

        <!-- System Configuration -->
        <div class="config-section">
            <h3>üñ•Ô∏è System Configuration</h3>
            <div id="systemParams"></div>
        </div>
    </div>

    <script>
        const registerMap = new Map();
        let registerCatalog = [];

        const GROUP_SECTIONS = {
            battery: 'batteryParams',
            charger: 'chargerParams',
            safety: 'safetyParams',
            advanced: 'advancedParams',
            system: 'systemParams'
        };

        window.addEventListener('load', async () => {
            await loadConfiguration();
        });

        async function loadConfiguration() {
            showStatus('Loading configuration...', 'info');

            try {
                const response = await fetch('/api/tinybms/registers');
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || 'Request failed');
                }

                registerCatalog = data.registers || [];
                registerMap.clear();
                registerCatalog.forEach(reg => registerMap.set(reg.address, reg));

                renderConfiguration();

                showStatus(`Loaded ${data.count ?? registerCatalog.length} registers`, 'success');
                setTimeout(() => hideStatus(), 3000);
            } catch (error) {
                console.error('[TinyBMS] loadConfiguration failed', error);
                showStatus(`Error loading configuration: ${error.message}`, 'error');
            }
        }

        function renderConfiguration() {
            Object.values(GROUP_SECTIONS).forEach(sectionId => {
                const container = document.getElementById(sectionId);
                if (container) {
                    container.innerHTML = '';
                }
            });

            registerCatalog.forEach(reg => {
                const sectionId = GROUP_SECTIONS[reg.group] || 'advancedParams';
                const container = document.getElementById(sectionId);
                if (container) {
                    container.appendChild(createConfigItem(reg));
                }
            });
        }

        function createConfigItem(reg) {
            const wrapper = document.createElement('div');
            wrapper.className = 'config-item';
            wrapper.id = `reg-${reg.address}`;

            const labelDiv = document.createElement('div');
            labelDiv.className = 'config-label';
            labelDiv.innerHTML = `
                <span class="config-label-main">${reg.label || reg.description}</span>
                <span class="config-label-desc">Register ${reg.address} ${reg.unit ? '(' + reg.unit + ')' : ''}</span>
                ${reg.comment ? '<span class="config-label-comment">' + reg.comment + '</span>' : ''}
            `;

            const inputDiv = document.createElement('div');
            inputDiv.className = 'config-input-wrapper';

            const value = typeof reg.value === 'number' ? reg.value : reg.default ?? 0;

            if (reg.is_enum) {
                const select = document.createElement('select');
                select.className = 'config-input';
                select.id = `input-${reg.address}`;

                (reg.enum_values || []).forEach(optionInfo => {
                    const option = document.createElement('option');
                    option.value = String(optionInfo.value);
                    option.textContent = optionInfo.label || optionInfo.value;
                    if (String(optionInfo.value) === String(value)) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });

                inputDiv.appendChild(select);
            } else {
                const input = document.createElement('input');
                input.type = 'number';
                input.className = 'config-input';
                input.id = `input-${reg.address}`;
                input.value = formatValue(value, reg.precision);
                if (typeof reg.min !== 'undefined') input.min = reg.min;
                if (typeof reg.max !== 'undefined') input.max = reg.max;
                if (typeof reg.step !== 'undefined' && reg.step > 0) input.step = reg.step;
                inputDiv.appendChild(input);
            }

            const rangeDiv = document.createElement('div');
            rangeDiv.className = 'config-range';
            if (!reg.is_enum && (typeof reg.min !== 'undefined' || typeof reg.max !== 'undefined')) {
                const minText = typeof reg.min !== 'undefined' ? formatValue(reg.min, reg.precision) : '-‚àû';
                const maxText = typeof reg.max !== 'undefined' ? formatValue(reg.max, reg.precision) : '+‚àû';
                rangeDiv.textContent = `[${minText} - ${maxText}]`;
            }

            const currentDiv = document.createElement('div');
            currentDiv.className = 'config-current';
            currentDiv.id = `current-${reg.address}`;
            currentDiv.textContent = formatValue(value, reg.precision);

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'config-actions';

            const readBtn = document.createElement('button');
            readBtn.className = 'btn-read';
            readBtn.id = `btn-read-${reg.address}`;
            readBtn.textContent = 'üìñ';
            readBtn.addEventListener('click', () => readRegister(reg.address));

            const writeBtn = document.createElement('button');
            writeBtn.className = 'btn-write';
            writeBtn.id = `btn-write-${reg.address}`;
            writeBtn.textContent = '‚úçÔ∏è';
            writeBtn.addEventListener('click', () => writeRegister(reg.address));
            if (reg.access === 'ro') {
                writeBtn.disabled = true;
            }

            actionsDiv.appendChild(readBtn);
            actionsDiv.appendChild(writeBtn);

            wrapper.appendChild(labelDiv);
            wrapper.appendChild(inputDiv);
            wrapper.appendChild(rangeDiv);
            wrapper.appendChild(actionsDiv);

            return wrapper;
        }

        function formatValue(value, precision = 0) {
            if (typeof value !== 'number' || Number.isNaN(value)) {
                return '';
            }
            return precision > 0 ? value.toFixed(precision) : value.toString();
        }

        function updateRegisterUI(reg) {
            const input = document.getElementById(`input-${reg.address}`);
            const current = document.getElementById(`current-${reg.address}`);

            if (input) {
                if (reg.is_enum) {
                    input.value = String(reg.value);
                } else {
                    input.value = formatValue(reg.value ?? reg.default ?? 0, reg.precision);
                }
            }

            if (current) {
                current.textContent = formatValue(reg.value ?? reg.default ?? 0, reg.precision);
            }
        }

        function applyRegisterUpdate(address, update) {
            const reg = registerMap.get(address);
            if (!reg) {
                return;
            }

            if (typeof update.value !== 'undefined') {
                reg.value = update.value;
            }
            if (typeof update.raw_value !== 'undefined') {
                reg.raw_value = update.raw_value;
            }

            updateRegisterUI(reg);
        }

        async function readRegister(address) {
            const button = document.getElementById(`btn-read-${address}`);
            if (button) {
                button.disabled = true;
            }

            try {
                const response = await fetch(`/api/tinybms/register?address=${address}`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || 'Read failed');
                }

                applyRegisterUpdate(address, {
                    value: data.value,
                    raw_value: data.raw_value
                });

                showStatus(`Register ${address} ‚Üí ${formatValue(data.value, (registerMap.get(address) || {}).precision)}`, 'success');
                setTimeout(() => hideStatus(), 2000);
            } catch (error) {
                console.error('[TinyBMS] readRegister failed', error);
                showStatus(`Error reading register ${address}: ${error.message}`, 'error');
            } finally {
                if (button) {
                    button.disabled = false;
                }
            }
        }

        async function writeRegister(address) {
            const reg = registerMap.get(address);
            if (!reg) {
                showStatus(`Unknown register ${address}`, 'error');
                return;
            }

            const input = document.getElementById(`input-${address}`);
            if (!input) {
                return;
            }

            const rawInput = input.value;
            const newValue = reg.is_enum ? parseInt(rawInput, 10) : parseFloat(rawInput);

            if (Number.isNaN(newValue)) {
                showStatus('Invalid value', 'error');
                return;
            }

            if (!reg.is_enum) {
                if (typeof reg.min !== 'undefined' && newValue < reg.min) {
                    showStatus(`Value ${newValue} below minimum ${reg.min}`, 'error');
                    return;
                }
                if (typeof reg.max !== 'undefined' && newValue > reg.max) {
                    showStatus(`Value ${newValue} above maximum ${reg.max}`, 'error');
                    return;
                }
            }

            if (['safety'].includes(reg.group) && !confirm(`‚ö†Ô∏è Modify safety register ${reg.address}?\n\n${reg.label || ''}`)) {
                return;
            }

            const button = document.getElementById(`btn-write-${address}`);
            if (button) {
                button.disabled = true;
            }

            try {
                const response = await fetch('/api/tinybms/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address, value: newValue })
                });

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.message || 'Write failed');
                }

                applyRegisterUpdate(address, {
                    value: data.value,
                    raw_value: data.raw_value
                });

                showStatus(`Register ${address} updated`, 'success');
                setTimeout(() => hideStatus(), 2000);
            } catch (error) {
                console.error('[TinyBMS] writeRegister failed', error);
                showStatus(`Error writing register ${address}: ${error.message}`, 'error');
            } finally {
                if (button) {
                    button.disabled = false;
                }
            }
        }

        async function readAllRegisters() {
            if (!confirm('Read all configuration registers from TinyBMS?')) {
                return;
            }

            showStatus('Reading all registers...', 'info');

            try {
                const response = await fetch('/api/tinybms/registers/read-all', { method: 'POST' });
                const data = await response.json();

                if (data.success === false) {
                    throw new Error(data.message || 'Read failed');
                }

                const registers = data.registers || [];
                registerCatalog = registers;
                registerMap.clear();
                registers.forEach(reg => {
                    registerMap.set(reg.address, reg);
                    updateRegisterUI(reg);
                });

                showStatus(`Read ${data.read_count ?? registers.length} registers`, 'success');
                setTimeout(() => hideStatus(), 2000);
            } catch (error) {
                console.error('[TinyBMS] readAllRegisters failed', error);
                showStatus(`Error reading registers: ${error.message}`, 'error');
            }
        }

        async function writeAllRegisters() {
            if (!confirm('‚ö†Ô∏è Write all modified values to TinyBMS?')) {
                return;
            }

            const payload = [];
            registerMap.forEach((reg, address) => {
                const input = document.getElementById(`input-${address}`);
                if (!input) {
                    return;
                }

                const rawValue = input.value;
                const newValue = reg.is_enum ? parseInt(rawValue, 10) : parseFloat(rawValue);
                if (Number.isNaN(newValue)) {
                    return;
                }

                const currentValue = reg.value ?? reg.default ?? 0;
                if (Math.abs(newValue - currentValue) > Math.pow(10, -(reg.precision ?? 0)) / 2) {
                    payload.push({ address, value: newValue });
                }
            });

            if (payload.length === 0) {
                showStatus('No changes to write', 'info');
                return;
            }

            showStatus(`Writing ${payload.length} registers...`, 'info');

            try {
                const response = await fetch('/api/tinybms/registers/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ registers: payload })
                });

                const data = await response.json();
                if (data.success === false && !data.results) {
                    throw new Error(data.message || 'Write failed');
                }

                (data.results || []).forEach(result => {
                    if (result.success) {
                        applyRegisterUpdate(result.address, {
                            value: result.value,
                            raw_value: result.raw_value
                        });
                    }
                });

                if (data.success) {
                    showStatus(`Successfully wrote ${data.written ?? payload.length} registers`, 'success');
                } else {
                    showStatus(`Completed with ${data.failed ?? 0} errors`, 'warning');
                }
                setTimeout(() => hideStatus(), 3000);
            } catch (error) {
                console.error('[TinyBMS] writeAllRegisters failed', error);
                showStatus(`Error writing registers: ${error.message}`, 'error');
            }
        }

        function resetToDefaults() {
            if (!confirm('Reset all values to defaults (not written)?')) {
                return;
            }

            registerMap.forEach((reg, address) => {
                const input = document.getElementById(`input-${address}`);
                if (input) {
                    if (reg.is_enum) {
                        input.value = String(reg.default ?? reg.value ?? 0);
                    } else {
                        input.value = formatValue(reg.default ?? reg.value ?? 0, reg.precision);
                    }
                }
            });

            showStatus('Inputs reset to defaults (not written)', 'info');
        }

        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
            statusEl.style.display = 'block';
        }

        function hideStatus() {
            const statusEl = document.getElementById('statusMessage');
            statusEl.style.display = 'none';
        }
    </script>
</body>
</html>
